class Region < ApplicationRecord
  belongs_to :user
  has_many :participations
  has_many :contests, through: :participations
  has_and_belongs_to_many :observations

  enum status: [:online, :deleted]

  def get_geokit_polygons
    polygons = []
    json = JSON.parse raw_polygon_json
    if json
      json.each do |polygon|
        points = polygon['coordinates'].map { |c| Geokit::LatLng.new c[1], c[0] }  
        polygons.push Geokit::Polygon.new(points)
      end
    end  
    polygons
  end

  def self.get_multipolygon_from_geojson geojson
    mp = 'MULTIPOLYGON['

    mp
  end  

  @@mp = 'MULTIPOLYGON(((153.145328992 -30.301972999,153.145448 -30.3016579995,153.145024992 -30.301903994,153.145328992 -30.301972999),(153.206055008 -30.096405994,153.206539008 -30.0956049995,153.205775008 -30.095585001,153.206055008 -30.096405994),(153.20762 -30.095739994,153.2077 -30.095247006,153.207330016 -30.0956760025,153.20762 -30.095739994),(153.226679008 -30.1623890005,153.229104992 -30.1609460005,153.227584 -30.159256007,153.225256 -30.1603490055,153.226679008 -30.1623890005),(153.208191008 -30.1307090085,153.208916992 -30.1300830055,153.206667008 -30.130580008,153.208191008 -30.1307090085),(153.144221376 -30.2961650535,153.14437536 -30.295076051,153.143278368 -30.2952060505,153.144221376 -30.2961650535),(153.208204992 -30.0960559925,153.208396992 -30.095799009,153.208008 -30.0959069935,153.208204992 -30.0960559925),(153.076459008 -30.432469002,153.078044992 -30.431767001,153.075618016 -30.429323003,153.076459008 -30.432469002),(153.208304 -30.0683439915,153.208423008 -30.068063994,153.208060992 -30.068017004,153.208304 -30.0683439915),(152.803453216 -30.1895667955,152.80134528 -30.1921247905,152.807121184 -30.1932027485,152.808750688 -30.1951781415,152.807544192 -30.196785736,152.808957184 -30.2002377435,152.81345776 -30.2021968195,152.813910176 -30.2047306905,152.817737088 -30.2071046475,152.817443136 -30.213353633,152.826853984 -30.2134895525,152.832857504 -30.2169611885,152.833628544 -30.2192355045,152.829566016 -30.222129515,152.83433488 -30.223434579,152.834310976 -30.2297184555,152.844917824 -30.2358893525,152.84509984 -30.2387493415,152.846935584 -30.2388196785,152.843667136 -30.2407669885,152.848876608 -30.245593324,152.848659872 -30.2519893105,152.855381888 -30.253443022,152.851103872 -30.2587922785,152.848032896 -30.256885317,152.846758816 -30.260212283,152.841557152 -30.2603863495,152.837516192 -30.269837389,152.831955296 -30.2694994495,152.833106304 -30.2734024315,152.827253376 -30.271470495,152.82571936 -30.267756509,152.824240416 -30.269097537,152.8227784 -30.264505541,152.820130464 -30.265800578,152.820620448 -30.2693605515,152.818937504 -30.2725525785,152.822954496 -30.2753565125,152.81763264 -30.2800045635,152.823751616 -30.286585476,152.816539808 -30.2938805255,152.81977984 -30.300369493,152.83408 -30.3115670065,152.836964 -30.3109499945,152.838811008 -30.3138389915,152.843152 -30.3131349925,152.846700992 -30.309712992,152.848523008 -30.311399008,152.855232 -30.312042993,152.857028992 -30.3158369915,152.863564 -30.320210003,152.864377312 -30.3229550515,152.878350176 -30.3274149205,152.884533024 -30.3253268625,152.890607008 -30.3294498095,152.895715872 -30.326838775,152.9018248 -30.3298887035,152.907264672 -30.327431663,152.922283488 -30.3318825225,152.939574304 -30.339980287,152.942118336 -30.3440762425,152.950659264 -30.3489381165,152.95183488 -30.351569575,152.9654656 -30.3485166865,152.95762368 -30.388758127,152.966591552 -30.3904137475,152.967724544 -30.3931777215,152.973212448 -30.394011683,152.978233408 -30.3979046565,152.98076832 -30.396933647,152.984879328 -30.403101584,152.99454016 -30.402912514,152.994224192 -30.405232525,153.039488864 -30.43195004,153.060199264 -30.4487533495,153.076319008 -30.4318900075,153.072116992 -30.4242059955,153.073892992 -30.4155050015,153.080550016 -30.4008619925,153.100156 -30.3760289985,153.104516 -30.3769969925,153.103619936 -30.3666409515,153.109788704 -30.3563199495,153.106311744 -30.3543709745,153.11345136 -30.340617057,153.124612896 -30.326353076,153.136082656 -30.3159350415,153.14286048 -30.3122210185,153.1488144 -30.313768007,153.152929312 -30.3094919725,153.1481264 -30.311819994,153.140124512 -30.309882045,153.140117504 -30.3064550495,153.14250144 -30.3031020355,153.150206336 -30.306484002,153.154572224 -30.305148006,153.152722272 -30.3036520035,153.148646336 -30.3049760115,153.146042368 -30.3024430285,153.140955456 -30.3016460485,153.139825472 -30.2996690645,153.139025472 -30.2965850775,153.140464416 -30.295388072,153.139446016 -30.290544994,153.140878368 -30.2843490665,153.147838208 -30.2776030415,153.144238272 -30.276680058,153.142791264 -30.2744850515,153.143920224 -30.270645062,153.147394016 -30.270862992,153.147519168 -30.269670038,153.145240192 -30.26768706,153.141475264 -30.268083071,153.139659264 -30.2667190845,153.140372224 -30.2642710905,153.138258272 -30.2625521075,153.1399872 -30.257835107,153.141427168 -30.257835107,153.140185184 -30.2558861135,153.143838048 -30.247679125,153.15519776 -30.2339401185,153.153842752 -30.232336113,153.15453872 -30.228094137,153.161180512 -30.215627135,153.163863008 -30.214543997,153.161760448 -30.2094111535,153.166987264 -30.1980291395,153.184708864 -30.1778241055,153.190595776 -30.1786730705,153.193348736 -30.1771310585,153.18955376 -30.176204079,153.189850752 -30.173698069,153.192010688 -30.172215072,153.189963744 -30.17119809,153.190773696 -30.1678430965,153.197857536 -30.159764054,153.206858368 -30.1563860095,153.202299456 -30.1559600285,153.200803456 -30.1538700465,153.201117376 -30.147392068,153.20383136 -30.1461940635,153.200722368 -30.145272079,153.199564384 -30.1412721015,153.201143296 -30.1345201195,153.205001216 -30.1294060905,153.204393184 -30.124254118,153.206919104 -30.1166351335,153.208976064 -30.112990134,153.213128032 -30.1132081195,153.212309024 -30.1118471115,153.213713984 -30.109724107,153.205137088 -30.1080271575,153.202839136 -30.109081158,153.19964112 -30.1039022125,153.199427136 -30.0990752295,153.201738048 -30.0945022145,153.20083104 -30.0865212405,153.203410976 -30.078338265,153.206029888 -30.0775372335,153.203630944 -30.075673266,153.203278944 -30.0729442755,153.204613888 -30.0700942765,153.207860832 -30.0685262535,153.202600896 -30.065365288,153.203350016 -30.060621,153.206343008 -30.0583139945,153.200671904 -30.059462308,153.196339968 -30.054904352,153.19557296 -30.048546346,153.197083904 -30.0405773785,153.21842544 -30.0030993385,153.231952 -29.983742992,153.234485088 -29.982094309,153.233366144 -29.9797533375,153.253877728 -29.952482321,153.258105664 -29.950321299,153.260046624 -29.952097299,153.261312576 -29.9474153005,153.258302624 -29.947243306,153.257693632 -29.9441073155,153.258614592 -29.941473341,153.261508992 -29.940113998,153.258139008 -29.9321380005,153.258386016 -29.9222229995,153.25656 -29.918656995,153.243668992 -29.916689002,153.244690016 -29.911478995,153.242504 -29.9114189995,153.241711008 -29.9073430055,153.239022016 -29.906623004,153.238304 -29.8972849995,153.230447168 -29.8974176075,153.226443008 -29.908506008,153.218782016 -29.9063120005,153.208596992 -29.907950009,153.208694016 -29.916468001,153.180252 -29.9132680005,153.171784992 -29.9238959915,153.166392992 -29.9237680085,153.159794016 -29.9302460055,153.160354016 -29.9286689915,153.155134016 -29.9213270075,153.152218016 -29.9370649945,153.133704992 -29.934637998,153.133326016 -29.936975991,153.128328992 -29.942228992,153.137467008 -29.942990008,153.135200608 -29.952502708,153.135968 -29.9545930045,153.137062016 -29.9564790055,153.144262016 -29.958134996,153.142292 -29.9705089985,153.145392992 -29.972744002,153.144242976 -29.9805060655,153.122411008 -29.9763450085,153.120959008 -29.9837169995,153.117664 -29.983224992,153.116864992 -29.9872670015,153.111192896 -29.986439404,153.109236 -29.9963330005,153.107112992 -29.9957439975,153.101016992 -29.998800993,153.096603008 -29.994806991,153.096274016 -29.996061994,153.094176992 -29.995792005,153.091040992 -30.013922005,153.100756992 -30.015222,153.100044992 -30.019258996,153.105284 -30.017301992,153.102077504 -30.029325771,153.10288256 -30.030650852,153.093327008 -30.0319319955,153.090290016 -30.0469929935,153.081872 -30.0458409985,153.083440992 -30.037095993,153.06302 -30.034544991,153.060107008 -30.038079009,153.056895008 -30.0387009975,153.054520256 -30.045769015,153.044326016 -30.0442549935,153.045046016 -30.0469899965,153.050378016 -30.0499810025,153.053540992 -30.0594500055,153.049751008 -30.063241007,153.051688 -30.064913999,153.051164992 -30.068275005,153.047232992 -30.072392994,153.041222016 -30.071499999,153.036803008 -30.074651992,153.035232 -30.0872360065,153.038472992 -30.089373996,153.017424352 -30.086996228,153.018937472 -30.0920111895,153.01662224 -30.09167621,153.017607232 -30.0964661745,152.998964608 -30.093794497,152.99836064 -30.0969165015,152.993821696 -30.096240567,152.994665696 -30.091821583,152.969025056 -30.0872408905,152.970141056 -30.0906248735,152.96698912 -30.092997887,152.96866512 -30.0974198495,152.966049184 -30.104841846,152.972017088 -30.1056407685,152.976658048 -30.1122646935,152.973350144 -30.1298826505,152.93872048 -30.1250425695,152.935378784 -30.125947201,152.93419744 -30.123753027,152.917705152 -30.1543470505,152.90698432 -30.1437472165,152.90007344 -30.1427782975,152.887924608 -30.1342514255,152.882790656 -30.1267624775,152.880737696 -30.1295714805,152.87817072 -30.127869499,152.872422816 -30.128755538,152.873300832 -30.132965509,152.869450944 -30.135768148,152.866541952 -30.133992555,152.867118944 -30.1399035085,152.864303008 -30.1394265415,152.862153056 -30.141278558,152.863166048 -30.1423925355,152.86190208 -30.1456805405,152.857165152 -30.147777571,152.856714144 -30.1461715675,152.852248224 -30.1459886025,152.84504832 -30.142214658,152.838816416 -30.1425276965,152.838820416 -30.144124709,152.834537504 -30.1404277245,152.833454528 -30.142516726,152.830115008 -30.142448979,152.828982592 -30.1444787435,152.82181872 -30.142717747,152.819243712 -30.1388977745,152.820918656 -30.134321781,152.82517408 -30.132410583,152.824458528 -30.1307759415,152.818325664 -30.1282787745,152.813467712 -30.128479777,152.808115808 -30.1256998005,152.807393888 -30.136868824,152.808656864 -30.1387208035,152.80478832 -30.143263534,152.808406464 -30.147379377,152.804047008 -30.1484308615,152.799705088 -30.151603889,152.79983312 -30.154026871,152.795668192 -30.155905879,152.797778208 -30.160760871,152.800435744 -30.162212788,152.799904512 -30.1705507565,152.806098112 -30.172646788,152.803582208 -30.1764468545,152.799625312 -30.1783823245,152.798750304 -30.183000831,152.803759264 -30.185719258,152.803453216 -30.1895667955),(153.156915008 -30.234522998,153.157303008 -30.2343969945,153.157494016 -30.233554005,153.156915008 -30.234522998),(153.2066 -30.13007,153.206988992 -30.129696004,153.205972992 -30.1297949975,153.2066 -30.13007),(153.208196992 -30.096405994,153.208144992 -30.0962049915,153.207835008 -30.096370992,153.208196992 -30.096405994),(153.182124992 -30.2411200055,153.181792 -30.2398590085,153.179231008 -30.240704995,153.182124992 -30.2411200055),(153.145467008 -30.3021389995,153.146002016 -30.3020600045,153.145876992 -30.3018370055,153.145467008 -30.3021389995),(153.266723008 -30.2073770045,153.268136 -30.2066040005,153.269434016 -30.2055319995,153.265586016 -30.204078991,153.266723008 -30.2073770045)))'

  def self.get_mp
    @@mp
  end

  def self.get_geojson_string_from_multipolygon multipolygon
    geojson_string = ''
    polygons = multipolygon.gsub('MULTIPOLYGON((', '').gsub('))', '').split '('

    geojson = {}
    geojson['type'] = 'Polygon'
    geojson['coordinates'] = []

    polygons.each do |p|
      Rails.logger.info ">>>>"
      Rails.logger.info p
      parts = p.gsub(')', '').strip.split ','
      parts.each do |c|
        Rails.logger.info c
        coordinates = c.split ' '
        Rails.logger.info coordinates
        arr = [coordinates[0].to_f, coordinates[1].to_f]
        Rails.logger.info arr
        Rails.logger.info "\n\n"
        geojson['coordinates'].push arr
      end  
    end  
    
    Rails.logger.info geojson

    JSON.generate geojson
  end

  def self.get_geojson_from_osm relation_id
    coordinates = []

    r = HTTParty.get "https://api.openstreetmap.org/api/0.6/relation/#{relation_id}.json"
    members = r['elements'][0]['members']
    Rails.logger.info "Got relationship, #{members.length} members"
  
    members.each do |m|
      if m['type']=='way'   
        rr = HTTParty.get "https://api.openstreetmap.org/api/0.6/way/#{m['ref']}.json"
        Rails.logger.info rr['elements'].inspect
        nodes = rr['elements'][0]['nodes']
        Rails.logger.info ">> Got way, #{nodes.length} nodes"

        nodes.each do |n|
          rrr = HTTParty.get "https://api.openstreetmap.org/api/0.6/node/#{n}.json" 
          Rails.logger.info ">>>> Got node #{rrr.body['elements'][0].inspect}"
          c = { lat: rrr.body['elements'][0]['lat'], lng: rrr.body['elements'][0]['lon'] }
          coordinates.push c
        end

      elsif m['type']=='node'
        rr = HTTParty.get "https://api.openstreetmap.org/api/0.6/node/#{n}.json"  
        c = { lat: rr.body['elements'][0]['lat'], lng: rr.body['elements'][0]['lon'] }
        coordinates.push c

      end 
    end

    Rails.logger.info coordinates.inspect
  end


  rails_admin do
    list do
      field :id
      field :name          
      field :description
      field :raw_polygon_json
    end
  end  





=begin
  def format_for_api(params={})
    data = {
        id: id,
        name: name,
        description: description,
        header_image_url: header_image_url,
        logo_image_url: logo_image_url,
        region_url: region_url,
        refresh_interval_mins: refresh_interval_mins,
        updated_at: updated_at
    }
    if params[:polygon_format] == :geo_json
        data[:polygon] = RGeo::GeoJSON.encode(multi_polygon)
    end
    
    return data
  end
=end

end
